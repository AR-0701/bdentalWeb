<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Modificar horario</title>
        <link rel="stylesheet" href="Admi1.css">
        <style>
            body {
                font-family: Arial, sans-serif;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            th, td {
                border: 1px solid #dddddd;
                text-align: center;
                padding: 8px;
                cursor: pointer;
            }
            th {
                background-color: #f2f2f2;
            }
            td.selected {
                background-color: #4CAF50;
                color: white;
            }
            .bloqueado {
                background-color: #f2f2f2; /* Cambia esto al color deseado */
                /* Otros estilos opcionales */
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div class="logo2">
                    <a href="PrincipaAdmin.jsp">
                        <img src="imagenes/loogo.png" alt="B - DENTAL">
                    </a>
                </div>
            </header>
            <main class="main">
                <div class="about">
                    <div class="text-content">
                        <div class="Titulo modify-title"><h1>Modificar horario</h1></div>
                    </div>
                </div>
                <div class="schedule-container">
                    <div class="form-container">
                        <div class="form-group">
                            <label for="hora-apertura">Hora de apertura:</label>
                            <input type="text" id="hora-apertura" readonly>
                        </div>
                        <div class="form-group">
                            <label for="hora-cierre">Hora de cierre:</label>
                            <input type="text" id="hora-cierre" readonly>
                        </div>
                        <div class="button-group">
                            <button id="bloquear">Bloquear</button>
                            <button id="desbloquear">Desbloquear</button>
                        </div>
                    </div>
                    <div class="calendar-container">
                        <h2 id="nombreMes"></h2>
                        <table id="calendar">
                            <thead>
                                <tr>
                                    <th>Dom.</th>
                                    <th>Lun.</th>
                                    <th>Mar.</th>
                                    <th>Mié.</th>
                                    <th>Jue.</th>
                                    <th>Vie.</th>
                                    <th>Sáb.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los días del mes se generarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <p>Fecha seleccionada: <input type="text" id="fechaSeleccionada" readonly></p>
                <div class="button-modify">
                    <button id="modificar">Modificar</button>
                </div>
            </main>
            <footer>
                <!-- Footer content -->
            </footer>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var calendarBody = document.querySelector('#calendar tbody');
                var nombreMes = document.getElementById('nombreMes');
                var horaAperturaInput = document.getElementById('hora-apertura');
                var horaCierreInput = document.getElementById('hora-cierre');
                var fechaSeleccionadaInput = document.getElementById('fechaSeleccionada');
                var meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                var fechaActual = new Date();
                var mesActual = fechaActual.getMonth();
                var anoActual = fechaActual.getFullYear();
                nombreMes.textContent = meses[mesActual] + ' ' + anoActual;

                // Variable para almacenar la fecha seleccionada
                let fechaSeleccionada = '';

                // Función para obtener la fecha en formato AAAA-MM-DD
                function obtenerFechaAAAAMMDD(d) {
                    let year = d.getFullYear();
                    let month = ('0' + (d.getMonth() + 1)).slice(-2);
                    let day = ('0' + d.getDate()).slice(-2);
                    return `${year}-${month}-${day}`;
                }

                // Crear calendario para el mes actual
                function crearCalendario(mes, año) {
                    calendarBody.innerHTML = '';

                    let primerDiaMes = new Date(año, mes, 1);
                    let ultimoDiaMes = new Date(año, mes + 1, 0);

                    let diaSemanaInicio = primerDiaMes.getDay();
                    let diasEnMes = ultimoDiaMes.getDate();

                    let date = 1;
                    for (let i = 0; i < 6; i++) {
                        let row = document.createElement('tr');
                        for (let j = 0; j < 7; j++) {
                            if (i === 0 && j < diaSemanaInicio) {
                                let cell = document.createElement('td');
                                row.appendChild(cell);
                            } else if (date > diasEnMes) {
                                break;
                            } else {
                                let cell = document.createElement('td');
                                cell.textContent = date;
                                cell.setAttribute('data-date', obtenerFechaAAAAMMDD(new Date(año, mes, date)));
                                cell.addEventListener('click', function () {
                                    // Remover clase de selección de la celda anteriormente seleccionada
                                    let selectedCell = document.querySelector('.selected');
                                    if (selectedCell) {
                                        selectedCell.classList.remove('selected');
                                    }

                                    // Agregar clase de selección a la celda clickeada
                                    this.classList.add('selected');

                                    // Guardar fecha seleccionada en la variable y mostrar en consola
                                    fechaSeleccionada = this.getAttribute('data-date');
                                    console.log('Fecha seleccionada:', fechaSeleccionada);

                                    // Mostrar fecha seleccionada en el input
                                    fechaSeleccionadaInput.value = fechaSeleccionada;

                                    // Obtener horarios para la fecha seleccionada
                                    obtenerHorarios(fechaSeleccionada);
                                });
                                row.appendChild(cell);
                                date++;
                            }
                        }
                        calendarBody.appendChild(row);
                    }
                }

                function obtenerHorarios(fecha) {
                    fetch('SvMostrarHorarios?fecha=' + fecha)
                            .then(response => response.json())
                            .then(data => {
                                if (data) {
                                    horaAperturaInput.value = data.horaApertura;
                                    horaCierreInput.value = data.horaCierre;
                                } else {
                                    horaAperturaInput.value = '---';
                                    horaCierreInput.value = '---';
                                }
                            })
                            .catch(error => console.error('Error:', error));
                }
                document.getElementById('bloquear').addEventListener('click', function () {
                    actualizarEstadoDia(true);
                });

                document.getElementById('desbloquear').addEventListener('click', function () {
                    actualizarEstadoDia(false);
                });

                function actualizarEstadoDia(bloquear) {
                    if (fechaSeleccionada) {
                        fetch('SvActualizarHorarios', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `fecha=${fechaSeleccionada}&bloquear=${bloquear}`
                        })
                                .then(response => response.json())
                                .then(data => {
                                    if (data) {
                                        let cell = document.querySelector(`td[data-date="${data.fecha}"]`);
                                        if (bloquear) {
                                            cell.classList.add('bloqueado');
                                        } else {
                                            cell.classList.remove('bloqueado');
                                        }
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                    } else {
                        alert('Por favor, seleccione una fecha primero.');
                    }
                }
                function obtenerDiasBloqueados() {
                    fetch('SvDiasBloqueados')
                            .then(response => response.json())
                            .then(data => {
                                if (Array.isArray(data)) {
                                    marcarDiasBloqueados(data);
                                } else {
                                    console.error('La respuesta de días bloqueados no es un arreglo válido:', data);
                                }
                            })
                            .catch(error => console.error('Error al obtener días bloqueados:', error));
                }


             function marcarDiasBloqueados(diasBloqueados) {
    if (!Array.isArray(diasBloqueados)) {
        console.error('Los días bloqueados no son un arreglo:', diasBloqueados);
        return;
    }

    diasBloqueados.forEach(dia => {
        if (typeof dia === 'object' && dia.fecha) {
            console.log('Procesando día bloqueado:', dia.fecha);

            // Convertir la fecha del objeto a un objeto Date
            let fechaBloqueada = new Date(dia.fecha);

            // Verificar si la conversión fue exitosa
            if (!isNaN(fechaBloqueada.getTime())) {
                // Formatear la fecha en AAAA-MM-DD
                let year = fechaBloqueada.getFullYear();
                let month = ('0' + (fechaBloqueada.getMonth() + 1)).slice(-2);
                let day = ('0' + fechaBloqueada.getDate()).slice(-2);
                let fechaFormateada = `${year}-${month}-${day}`;

                // Buscar la celda correspondiente en el calendario
                let cell = document.querySelector(`td[data-date="${fechaFormateada}"]`);
                if (cell) {
                    console.log(`Encontró la celda para ${fechaFormateada}`);
                    cell.classList.add('bloqueado');
                } else {
                    console.log(`No se encontró la celda para ${fechaFormateada}`);
                }
            } else {
                console.error('Fecha inválida:', dia.fecha);
            }
        } else {
            console.error('Objeto de día bloqueado inválido:', dia);
        }
    });
}


                crearCalendario(mesActual, anoActual);
                obtenerDiasBloqueados();  // Obtener y marcar los días bloqueados
            });
        </script>
    </body>
</html>
